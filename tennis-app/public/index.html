<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big 12 Women's Tennis Standings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .policy-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }

        .policy-section {
            margin-bottom: 15px;
        }

        .policy-section-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .policy-text {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .policy-list {
            padding-left: 20px;
            margin-bottom: 12px;
        }

        .policy-list li {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 6px;
        }

        .header {
            background-color: #000;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            grid-column: 1 / -1;
        }

        .team-link {
            color: inherit;
            text-decoration: none;
            display: inline-block;
            position: relative;
        }

        .team-link::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #000;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .team-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px 0;
        }

        .header h1 {
            color: white;
            margin: 0;
        }

        .standings-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .team-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
        }

        .team-card:hover {
            transform: translateX(5px);
            background-color: #f8f9fa;
        }

        .seed-number {
            width: 40px;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            text-align: center;
        }

        .team-info {
            flex: 1;
            margin-left: 15px;
        }

        .team-name {
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .team-record {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .tiebreaker-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .refresh-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .refresh-button:hover {
            background-color: #444;
        }

        .tiebreaker-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tiebreaker-section h2 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .tiebreaker-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border-left: 4px solid #000;
        }

        .tiebreaker-group h3 {
            font-size: 1rem;
            color: #495057;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .tiebreaker-teams {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .tiebreaker-explanation {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #888;
            font-style: italic;
        }

        .tiebreaker-row {
            background-color: #f8f9fa;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            border-left: 4px solid #000;
        }

        .tiebreaker-row.show {
            max-height: 100px;
            padding: 15px;
        }

        .tiebreaker-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tiebreaker-icon {
            font-size: 1.2rem;
            color: #000;
        }

        .tiebreaker-text {
            flex: 1;
            font-size: 0.9rem;
            color: #666;
        }

        .tied-team-row {
            background-color: rgba(0, 0, 0, 0.02);
        }

        tr.has-tiebreaker {
            cursor: pointer;
        }

        tr.has-tiebreaker:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tiebreaker-arrow {
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.3s ease;
        }

        .tiebreaker-arrow.rotated {
            transform: rotate(180deg);
        }

        .upcoming-match {
            background-color: #f0f8ff;
        }

        .upcoming-match:hover {
            background-color: #e6f2ff;
        }

        .conference-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            margin-right: 5px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #000;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">Big 12 Women's Tennis Standings</h1>
                <button onclick="fetchStandings()" class="refresh-button">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="standings-container" class="standings-container">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="policy-title">Big 12 Tennis Tiebreaker Policy</div>
            
            <div class="policy-section">
                <div class="policy-text">
                    Each Conference team shall be seeded according to its dual match win percentage.
                </div>
            </div>

            <div class="policy-section">
                <div class="policy-section-title">Two-Team Ties</div>
                <div class="policy-text">
                    When only two teams are tied, head-to-head competition will break the tie and determine the higher seed.
                </div>
            </div>

            <div class="policy-section">
                <div class="policy-section-title">Multi-Team Ties</div>
                <div class="policy-text">
                    When ties involve more than two teams:
                </div>
                <ol class="policy-list">
                    <li>Results from the collective head-to-head competition during the regular season among the tied teams in a "mini round-robin" format, ranking the tied teams by winning percentage from highest to lowest.</li>
                    <li>If two teams remain tied with the same winning percentage, the two-team tiebreaking system is used, starting with head-to-head results.</li>
                    <li>If more than two teams remain tied with the same winning percentage, a second mini round-robin format is implemented.</li>
                    <li>If still tied, each team's record versus the highest position in the final standings, and then continuing down through the standings, eliminating tied teams with inferior records until one team gains an advantage.</li>
                    <li>When arriving at another group of tied teams while comparing records, use each team's record against the collective tied teams as a group.</li>
                    <li>If tiebreaking procedures are unsuccessful and more than two teams remain tied, ITA rankings will be used to assign seeds, starting with the highest ranked team.</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        async function fetchStandings() {
            const standingsDiv = document.getElementById('standings-container');
            standingsDiv.innerHTML = '<div class="loading">Loading standings...</div>';
            
            try {
                const response = await fetch('/api/tennis/standings');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data.standings || data.standings.length === 0) {
                    standingsDiv.innerHTML = '<div class="error">No standings data available</div>';
                    return;
                }

                const table = document.createElement('table');
                
                // Create table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Overall</th>
                        <th>Conference</th>
                        <th>Conf Win %</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                let lastTeamRecord = null;
                let tiedGroupStartIndex = -1;

                data.standings.forEach((team, index) => {
                    const currentRecord = team.confRecord;
                    let isTiedWithPrevious = false;

                    if (currentRecord === lastTeamRecord && lastTeamRecord !== null) {
                        isTiedWithPrevious = true;
                        if (tiedGroupStartIndex === -1) {
                            // Mark the start of this tied group (the previous team's index)
                            tiedGroupStartIndex = index - 1;
                        }
                    } else {
                        // If the record changes, and we were in a tied group, process it
                        if (tiedGroupStartIndex !== -1) {
                            const groupSize = index - tiedGroupStartIndex;
                            if (groupSize > 1) {
                                const tiedTeamsData = data.standings.slice(tiedGroupStartIndex, index)
                                    .map((t, i) => ({ team: t, index: tiedGroupStartIndex + i }));
                                processTiedTeams(tbody, tiedTeamsData);
                            }
                        }
                        tiedGroupStartIndex = -1; // Reset group tracking
                    }
                    
                    const row = document.createElement('tr');
                    const teamNameWithRank = team.ita_rank ? `#${team.ita_rank} ${team.team}` : team.team;
                    
                    // Add class if this row is tied with the *next* row (which requires looking ahead slightly or handling in processTiedTeams)
                    // For simplicity, we add arrow based on tie with *previous* row, processTiedTeams inserts explanation below the higher ranked team in the pair
                    if (isTiedWithPrevious) {
                         // Add class to the PREVIOUS row to indicate it has a tiebreaker below it
                        const previousRow = tbody.children[tbody.children.length - 1];
                        if(previousRow && !previousRow.classList.contains('has-tiebreaker')) {
                             previousRow.classList.add('has-tiebreaker');
                             // Add arrow to the previous row's team name cell
                             const teamCell = previousRow.cells[1]; 
                             const arrowSpan = document.createElement('span');
                             arrowSpan.className = 'tiebreaker-arrow';
                             arrowSpan.innerHTML = 'â–¼';
                             teamCell.appendChild(arrowSpan);
                        }
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><a href="/team/${team.team}" class="team-link">${teamNameWithRank}</a></td>
                        <td>${team.wins}-${team.losses}</td>
                        <td>${team.confRecord}</td>
                        <td>${(team.win_percent * 100).toFixed(1)}%</td>
                    `;
                    
                    tbody.appendChild(row);
                    lastTeamRecord = currentRecord;
                });

                // Process any remaining tied group at the end of the list
                if (tiedGroupStartIndex !== -1) {
                    const groupSize = data.standings.length - tiedGroupStartIndex;
                     if (groupSize > 1) {
                          const tiedTeamsData = data.standings.slice(tiedGroupStartIndex)
                              .map((t, i) => ({ team: t, index: tiedGroupStartIndex + i }));
                          processTiedTeams(tbody, tiedTeamsData);
                     }
                }

                table.appendChild(tbody);
                standingsDiv.innerHTML = '';
                standingsDiv.appendChild(table);

                // REMOVE ROW CLICK HANDLER
                /*
                // Add click handlers for tiebreaker rows
                document.querySelectorAll('.has-tiebreaker').forEach(row => {
                    row.addEventListener('click', function(e) {
                        // Don't trigger if clicking on the team link
                        if (e.target.tagName === 'A') return;
                        
                        const nextRow = this.nextElementSibling;
                        if (nextRow && nextRow.classList.contains('tiebreaker-row')) {
                            nextRow.classList.toggle('show');
                            const arrow = this.querySelector('.tiebreaker-arrow');
                            if (arrow) {
                                arrow.classList.toggle('rotated');
                            }
                        }
                    });
                });
                */
            } catch (error) {
                console.error('Error:', error);
                standingsDiv.innerHTML = `
                    <div class="error">
                        Error loading standings. Please try refreshing the page.
                        <br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function processTiedTeams(tbody, tiedTeams) {
            // Determine the conference record for this group
            const confRecord = tiedTeams[0].team.confRecord;

            // Iterate through the pairs of tied teams (as ordered by the server)
            for (let i = 0; i < tiedTeams.length - 1; i++) {
                const team1 = tiedTeams[i].team; // Higher ranked team in pair
                const team2 = tiedTeams[i + 1].team; // Lower ranked team in pair
                let explanation = '';

                // --- Specific Tiebreaker Explanations --- 
                // Two-way tie at 8-1 (Tech vs OSU)
                if (confRecord === '8-1' && team1.team === 'Texas Tech' && team2.team === 'Oklahoma State') {
                    explanation = 'Texas Tech wins tiebreaker over Oklahoma State due to head-to-head victory.';
                }
                // Five-way tie at 6-3 (Ranked: AZ > ASU > TCU > Baylor > BYU)
                else if (confRecord === '6-3' && tiedTeams.length === 5) {
                    if (team1.team === 'Arizona' && team2.team === 'Arizona State') {
                        explanation = 'Tiebreaker Step 1 (Mini Round-Robin): Arizona ranked #1 in group (2-0 record vs tied teams).';
                    } else if (team1.team === 'Arizona State' && team2.team === 'TCU') {
                         explanation = 'Tiebreaker Step 1 (Mini Round-Robin): Arizona State ranked #2 in group (1-1 record vs tied teams).';
                    } else if (team1.team === 'TCU' && team2.team === 'Baylor') {
                        explanation = 'Tiebreaker Step 4 (Record vs Highest): TCU ranked #3, Baylor #4 based on record vs #2 Texas Tech (after 0-0 mini round-robin tie).';
                    } else if (team1.team === 'Baylor' && team2.team === 'BYU') {
                         explanation = 'Tiebreaker Step 1 (Mini Round-Robin): BYU ranked #5 in group (0-2 record vs tied teams).';
                    }
                }
                // Three-way tie at 1-9 (Ranked: WVU > Cincy > Houston)
                 else if (confRecord === '1-9' && tiedTeams.length === 3) {
                    if (team1.team === 'West Virginia' && team2.team === 'Cincinnati') {
                        explanation = 'Tiebreaker Step 1 (Mini Round-Robin): West Virginia ranked #1 in group (2-0 record vs tied teams).';
                    } else if (team1.team === 'Cincinnati' && team2.team === 'Houston') {
                         explanation = 'Tiebreaker Step 1 (Mini Round-Robin): Cincinnati ranked #2 (1-1 record), Houston ranked #3 (0-2 record) vs tied teams.';
                    }
                }
                // --- Default Tiebreaker (ITA Rank if not covered above) ---
                else {
                     if (team1.ita_rank && team2.ita_rank) {
                        explanation = `${team1.team} wins tiebreaker over ${team2.team} due to higher ITA ranking (#${team1.ita_rank} vs #${team2.ita_rank}).`;
                    } else if (team1.ita_rank) {
                        explanation = `${team1.team} wins tiebreaker over ${team2.team} due to having an ITA ranking (#${team1.ita_rank}).`;
                    } else if (team2.ita_rank) {
                        explanation = `${team1.team} loses tiebreaker to ${team2.team} due to lower ITA ranking (Unranked vs #${team2.ita_rank}).`;
                    } else {
                        explanation = 'Teams remain tied after initial tiebreakers (further steps may apply).';
                    }
                }

                // Insert the explanation row only if an explanation was generated
                if (explanation) {
                    const tiebreakerRow = document.createElement('tr');
                    tiebreakerRow.className = 'tiebreaker-row';
                    tiebreakerRow.innerHTML = `
                        <td colspan="5">
                            <div class="tiebreaker-content">
                                <div class="tiebreaker-icon">ðŸŽ¾</div>
                                <div class="tiebreaker-text">${explanation}</div>
                            </div>
                        </td>
                    `;
                    
                    // Find the row element for team1 to insert after
                    let firstTeamRowElement = findTeamRowByIndex(tbody, tiedTeams[i].index);

                    if (firstTeamRowElement) {
                        // Insert after the row corresponding to team1
                         tbody.insertBefore(tiebreakerRow, firstTeamRowElement.nextSibling);
                    } else {
                        console.error("Could not find the anchor row to insert tiebreaker info for", team1.team);
                    }
                }
            }
        }

        // Helper function to find team row by its original index in the standings data
        function findTeamRowByIndex(tbody, index) {
            const allTeamRows = tbody.querySelectorAll('tr:not(.tiebreaker-row)');
            if (index < allTeamRows.length) {
                return allTeamRows[index];
            }
            return null;
        }

        // Add click handlers for tiebreaker ARROWS
        function addArrowClickHandlers() {
             document.querySelectorAll('.tiebreaker-arrow').forEach(arrow => {
                // Remove any existing listener to prevent duplicates on refresh
                const newArrow = arrow.cloneNode(true);
                arrow.parentNode.replaceChild(newArrow, arrow);
                
                newArrow.addEventListener('click', function(e) {
                    e.stopPropagation(); // Prevent triggering row click if any
                    const parentRow = this.closest('tr');
                    const nextRow = parentRow ? parentRow.nextElementSibling : null;
                    
                    if (nextRow && nextRow.classList.contains('tiebreaker-row')) {
                        nextRow.classList.toggle('show');
                        this.classList.toggle('rotated');
                    }
                });
            });
        }

        // Load standings when page loads
        document.addEventListener('DOMContentLoaded', async () => {
            await fetchStandings(); // Wait for standings to load
            addArrowClickHandlers(); // Then add click handlers to the arrows
        });
    </script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</body>
</html> 