<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Big 12 Women's Tennis Standings</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        :root {
            --primary-color: #0d6efd;
            --secondary-color: #6c757d;
        }

        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 20px;
        }

        .main-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .sidebar {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 20px;
            max-height: calc(100vh - 40px);
            overflow-y: auto;
        }

        .policy-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #000;
        }

        .policy-section {
            margin-bottom: 15px;
        }

        .policy-section-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-bottom: 8px;
        }

        .policy-text {
            font-size: 0.85rem;
            color: #555;
            line-height: 1.5;
            margin-bottom: 12px;
        }

        .policy-list {
            padding-left: 20px;
            margin-bottom: 12px;
        }

        .policy-list li {
            font-size: 0.85rem;
            color: #555;
            margin-bottom: 6px;
        }

        .header {
            background-color: #000;
            color: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 30px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            grid-column: 1 / -1;
        }

        .team-link {
            color: inherit;
            text-decoration: none;
            display: inline-block;
            position: relative;
        }

        .team-link::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 2px;
            bottom: -2px;
            left: 0;
            background-color: #000;
            transform: scaleX(0);
            transform-origin: bottom right;
            transition: transform 0.3s ease-out;
        }

        .team-link:hover::after {
            transform: scaleX(1);
            transform-origin: bottom left;
        }

        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: #f8f9fa;
            font-weight: bold;
            color: #495057;
        }

        tr:hover {
            background-color: #f8f9fa;
        }

        .loading {
            text-align: center;
            padding: 20px;
            font-style: italic;
            color: #666;
        }

        .error {
            color: #dc3545;
            text-align: center;
            padding: 20px;
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            margin: 20px 0;
        }

        .header h1 {
            color: white;
            margin: 0;
        }

        .standings-container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .team-card {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: transform 0.2s;
        }

        .team-card:hover {
            transform: translateX(5px);
            background-color: #f8f9fa;
        }

        .seed-number {
            width: 40px;
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.2rem;
            text-align: center;
        }

        .team-info {
            flex: 1;
            margin-left: 15px;
        }

        .team-name {
            font-weight: 500;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .team-record {
            color: var(--secondary-color);
            font-size: 0.9rem;
        }

        .tiebreaker-info {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .refresh-button {
            display: block;
            margin: 20px auto;
            padding: 10px 20px;
            background-color: #333;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .refresh-button:hover {
            background-color: #444;
        }

        .tiebreaker-section {
            margin-top: 30px;
            padding: 20px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .tiebreaker-section h2 {
            font-size: 1.2rem;
            color: #333;
            margin-bottom: 15px;
            font-weight: 600;
        }

        .tiebreaker-group {
            margin-bottom: 15px;
            padding: 15px;
            background-color: white;
            border-radius: 6px;
            border-left: 4px solid #000;
        }

        .tiebreaker-group h3 {
            font-size: 1rem;
            color: #495057;
            margin-bottom: 10px;
            font-weight: 500;
        }

        .tiebreaker-teams {
            color: #666;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        .tiebreaker-explanation {
            margin-top: 8px;
            font-size: 0.9rem;
            color: #888;
            font-style: italic;
        }

        .tiebreaker-row {
            background-color: #f8f9fa;
            overflow: hidden;
            max-height: 0;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            border-left: 4px solid #000;
        }

        .tiebreaker-row.show {
            max-height: 100px;
            padding: 15px;
        }

        .tiebreaker-content {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .tiebreaker-icon {
            font-size: 1.2rem;
            color: #000;
        }

        .tiebreaker-text {
            flex: 1;
            font-size: 0.9rem;
            color: #666;
        }

        .tied-team-row {
            background-color: rgba(0, 0, 0, 0.02);
        }

        tr.has-tiebreaker {
            cursor: pointer;
        }

        tr.has-tiebreaker:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .tiebreaker-arrow {
            display: inline-block;
            margin-left: 8px;
            transition: transform 0.3s ease;
        }

        .tiebreaker-arrow.rotated {
            transform: rotate(180deg);
        }

        .upcoming-matches-section {
            margin-top: 30px;
            margin-bottom: 30px;
        }

        .upcoming-matches {
            background-color: white;
            border-radius: 8px;
            overflow: hidden;
        }

        .upcoming-match {
            background-color: #f0f8ff;
        }

        .upcoming-match:hover {
            background-color: #e6f2ff;
        }

        .view-more {
            text-align: center;
            padding: 15px;
        }

        .conference-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background-color: #000;
            border-radius: 50%;
            margin-right: 5px;
        }

        .btn {
            display: inline-block;
            padding: 8px 16px;
            background-color: #000;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            transition: background-color 0.2s;
        }

        .btn:hover {
            background-color: #333;
        }

        .legend {
            margin-top: 20px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .legend-text {
            font-size: 0.85rem;
            color: #555;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="d-flex justify-content-between align-items-center">
                <h1 class="mb-0">Big 12 Women's Tennis Standings</h1>
                <button onclick="fetchStandings()" class="refresh-button">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>

        <div class="main-content">
            <div id="standings-container" class="standings-container">
                <div class="loading">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="policy-title">Big 12 Tennis Tiebreaker Policy</div>
            
            <div class="policy-section">
                <div class="policy-text">
                    Each Conference team shall be seeded according to its dual match win percentage.
                </div>
            </div>

            <div class="policy-section">
                <div class="policy-section-title">Two-Team Ties</div>
                <div class="policy-text">
                    When only two teams are tied, head-to-head competition will break the tie and determine the higher seed.
                </div>
            </div>

            <div class="policy-section">
                <div class="policy-section-title">Multi-Team Ties</div>
                <div class="policy-text">
                    When ties involve more than two teams:
                </div>
                <ol class="policy-list">
                    <li>Results from the collective head-to-head competition during the regular season among the tied teams in a "mini round-robin" format, ranking the tied teams by winning percentage from highest to lowest.</li>
                    <li>If two teams remain tied with the same winning percentage, the two-team tiebreaking system is used, starting with head-to-head results.</li>
                    <li>If more than two teams remain tied with the same winning percentage, a second mini round-robin format is implemented.</li>
                    <li>If still tied, each team's record versus the highest position in the final standings, and then continuing down through the standings, eliminating tied teams with inferior records until one team gains an advantage.</li>
                    <li>When arriving at another group of tied teams while comparing records, use each team's record against the collective tied teams as a group.</li>
                    <li>If tiebreaking procedures are unsuccessful and more than two teams remain tied, ITA rankings will be used to assign seeds, starting with the highest ranked team.</li>
                </ol>
            </div>
        </div>
    </div>

    <script>
        async function fetchStandings() {
            const standingsDiv = document.getElementById('standings-container');
            standingsDiv.innerHTML = '<div class="loading">Loading standings...</div>';
            
            try {
                const response = await fetch('/api/tennis/standings');
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();
                
                if (!data.standings || data.standings.length === 0) {
                    standingsDiv.innerHTML = '<div class="error">No standings data available</div>';
                    return;
                }

                const table = document.createElement('table');
                
                // Create table header
                const thead = document.createElement('thead');
                thead.innerHTML = `
                    <tr>
                        <th>Rank</th>
                        <th>Team</th>
                        <th>Overall</th>
                        <th>Conference</th>
                        <th>Conf Win %</th>
                    </tr>
                `;
                table.appendChild(thead);
                
                // Create table body
                const tbody = document.createElement('tbody');
                let lastTeamRecord = null;
                let tiedTeams = [];

                data.standings.forEach((team, index) => {
                    // Check if this team has the same conference record as the previous team
                    const currentRecord = team.confRecord;
                    
                    if (currentRecord === lastTeamRecord) {
                        // Add this team to the tied teams group
                        tiedTeams.push({ team, index });
                    } else {
                        // If we had tied teams, process them
                        if (tiedTeams.length > 1) {
                            processTiedTeams(tbody, tiedTeams);
                        }
                        // Start a new potential tie group
                        tiedTeams = [{ team, index }];
                    }
                    
                    const row = document.createElement('tr');
                    const teamNameWithRank = team.ita_rank ? `#${team.ita_rank} ${team.team}` : team.team;
                    
                    // Add classes if this is part of a tied group
                    if (currentRecord === lastTeamRecord) {
                        row.classList.add('tied-team-row', 'has-tiebreaker');
                    }
                    
                    row.innerHTML = `
                        <td>${index + 1}</td>
                        <td><a href="/team/${team.team}" class="team-link">${teamNameWithRank}</a>${currentRecord === lastTeamRecord ? '<span class="tiebreaker-arrow">▼</span>' : ''}</td>
                        <td>${team.wins}-${team.losses}</td>
                        <td>${team.confRecord}</td>
                        <td>${(team.win_percent * 100).toFixed(1)}%</td>
                    `;
                    
                    tbody.appendChild(row);
                    lastTeamRecord = currentRecord;
                });

                // Process any remaining tied teams
                if (tiedTeams.length > 1) {
                    processTiedTeams(tbody, tiedTeams);
                }

                table.appendChild(tbody);
                standingsDiv.innerHTML = '';
                standingsDiv.appendChild(table);

                // Add upcoming matches section
                if (data.standings && data.standings.length > 0) {
                    // Fetch upcoming matches for the first team to display
                    try {
                        const matchesResponse = await fetch(`/api/tennis/team/${encodeURIComponent(data.standings[0].team)}`);
                        if (matchesResponse.ok) {
                            const matchesData = await matchesResponse.json();
                            const upcomingMatches = matchesData.matches
                                .filter(match => match.isUpcoming)
                                .sort((a, b) => new Date(a.date) - new Date(b.date))
                                .slice(0, 5); // Show only the next 5 matches
                            
                            if (upcomingMatches.length > 0) {
                                const upcomingSection = document.createElement('div');
                                upcomingSection.className = 'upcoming-matches-section';
                                upcomingSection.innerHTML = `
                                    <h2 class="section-title">Upcoming Matches</h2>
                                    <div class="upcoming-matches">
                                        <table>
                                            <thead>
                                                <tr>
                                                    <th>Date</th>
                                                    <th>Teams</th>
                                                    <th>Location</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${upcomingMatches.map(match => `
                                                    <tr class="upcoming-match">
                                                        <td>${new Date(match.date).toLocaleDateString()}</td>
                                                        <td>${match.isConference ? '<span class="conference-indicator"></span>' : ''}${data.standings[0].team} vs ${match.opponent}</td>
                                                        <td>${match.location}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                        <div class="view-more">
                                            <a href="/team/${encodeURIComponent(data.standings[0].team)}" class="btn">View More Matches</a>
                                        </div>
                                    </div>
                                `;
                                standingsDiv.appendChild(upcomingSection);
                            }
                        }
                    } catch (error) {
                        console.error('Error loading upcoming matches:', error);
                    }
                }

                // Add legend
                const legendDiv = document.createElement('div');
                legendDiv.className = 'legend';
                legendDiv.innerHTML = `
                    <span class="conference-indicator"></span> 
                    <span class="legend-text">Conference Match</span>
                `;
                standingsDiv.appendChild(legendDiv);

                // Add click handlers for tiebreaker rows
                document.querySelectorAll('.has-tiebreaker').forEach(row => {
                    row.addEventListener('click', function(e) {
                        // Don't trigger if clicking on the team link
                        if (e.target.tagName === 'A') return;
                        
                        const nextRow = this.nextElementSibling;
                        if (nextRow && nextRow.classList.contains('tiebreaker-row')) {
                            nextRow.classList.toggle('show');
                            const arrow = this.querySelector('.tiebreaker-arrow');
                            if (arrow) {
                                arrow.classList.toggle('rotated');
                            }
                        }
                    });
                });
            } catch (error) {
                console.error('Error:', error);
                standingsDiv.innerHTML = `
                    <div class="error">
                        Error loading standings. Please try refreshing the page.
                        <br>
                        ${error.message}
                    </div>
                `;
            }
        }

        function processTiedTeams(tbody, tiedTeams) {
            // Sort tied teams by ITA rank
            tiedTeams.sort((a, b) => {
                if (!a.team.ita_rank && !b.team.ita_rank) return 0;
                if (!a.team.ita_rank) return 1;
                if (!b.team.ita_rank) return -1;
                return a.team.ita_rank - b.team.ita_rank;
            });

            // Insert tiebreaker explanation after each tied team except the last
            for (let i = 0; i < tiedTeams.length - 1; i++) {
                const currentTeam = tiedTeams[i];
                const nextTeam = tiedTeams[i + 1];
                
                const tiebreakerRow = document.createElement('tr');
                tiebreakerRow.className = 'tiebreaker-row';
                
                let explanation = '';
                // Specific tiebreaker explanations for certain team pairs
                if (currentTeam.team.team === 'Texas Tech' && nextTeam.team.team === 'Oklahoma State') {
                    explanation = 'Texas Tech wins tiebreaker over Oklahoma State due to head-to-head victory';
                } else if (currentTeam.team.team === 'West Virginia' && nextTeam.team.team === 'Houston') {
                    explanation = 'West Virginia wins tiebreaker over Houston due to head-to-head victory';
                } else if (currentTeam.team.team === 'Arizona State') {
                    explanation = 'Arizona State (2-0) wins mini round-robin among 5 teams tied at 6-3';
                } else if (currentTeam.team.team === 'Arizona') {
                    explanation = 'Arizona (1-1) places second in mini round-robin among 5 teams tied at 6-3';
                } else if (currentTeam.team.team === 'Baylor') {
                    explanation = 'Baylor wins head-to-head tiebreaker over TCU after both tied at 0-0 in mini round-robin';
                } else if (currentTeam.team.team === 'TCU') {
                    explanation = 'TCU places 7th after losing head-to-head tiebreaker with Baylor (both 0-0 in mini round-robin)';
                } else if (currentTeam.team.team === 'BYU') {
                    explanation = 'BYU (0-2) places 8th in mini round-robin among 5 teams tied at 6-3';
                }

                tiebreakerRow.innerHTML = `
                    <td colspan="5">
                        <div class="tiebreaker-content">
                            <div class="tiebreaker-icon">🎾</div>
                            <div class="tiebreaker-text">${explanation}</div>
                        </div>
                    </td>
                `;
                
                // Insert after the current team's row
                const currentTeamRow = tbody.children[tbody.children.length - 1];
                tbody.insertBefore(tiebreakerRow, currentTeamRow.nextSibling);
            }
        }

        // Load standings when page loads
        document.addEventListener('DOMContentLoaded', fetchStandings);
    </script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</body>
</html> 